:php
   $PHP = '../'

include ../../bundle.pug

include ../../Blocks/item_T_list/item_T_list.pug


+die-if-bad()
- var global = { 'page-name': 'field' };
+get-user-info()

:php
   if (!isset($_GET['view']))
      header('Location: ./../field?view=tree');

   function query_update ($key, $value) { 
      if (!isset($_GET[$key])) 
         return; 
      return './?' . str_replace("$key=".$_GET[$key], "$key=$value", $_SERVER['QUERY_STRING']); 
   };

   $types = $orm->table('type')->select('*')();
   
   use JustField\DBItem as DBItem;
   

- let tmp, tmp1

<!DOCTYPE html>
html(lang="en")
   head
      meta(charset="UTF-8")
      meta(name="viewport", content="width=device-width, initial-scale=1.0")
      meta(http-equiv="X-UA-Compatible", content="ie=edge")
      title Fields | Just Field
      +favicon()
   body.row
      +aside()
      main(style!=`<?= "width: $anti_aside_width;" ?>`).rel
         .row.page_tabs
            - tmp = `<?= query_update('view', 'tree') ?>`
            +box('a', `<?php echo ($_GET['view'] == 'tree' ? 'light' : 'dark') ?>`)(href!=tmp).tdn
               | Tree View
            - tmp = `<?= query_update('view', 'type') ?>`
            +box('a', `<?php echo ($_GET['view'] == 'type' ? 'light' : 'dark') ?>`)(href!=tmp).tdn
               | Type View

         <?php if ($_GET['view'] == 'tree') : ?>
            .page_path.row.aic.w100.pl1
               :php
                  $full_path = (array_key_exists('p', $_GET) ? $_GET['p'] : '');
                  $curr_path_i = 0;
                  if (array_key_exists('pi', $_GET))
                     $curr_path_i = $_GET['pi'];
                  $curr_path_i = intval($curr_path_i);
                  
                  $parts = explode('/', $full_path);

                  $path_parts = [];
                  for ($i = 0; $i < $curr_path_i; $i++)
                     array_push($path_parts, $parts[$i]);
                  $path = implode('/', $path_parts);
                  
                  $global['path'] = $path;
                  $global['path_parts'] = $path_parts;

               <script>var state = {};</script>
               script state.path = '<?= $path ?>';

               :php
                  //var_dump($parts);
                  echo '<script>console.log(`' . 'curr_path_i: ' . $curr_path_i .'`);</script>';
                  echo '<script>console.log(`' . 'count parts: ' . count($parts) .'`);</script>';
                  if ($curr_path_i < count($parts)-1)
                     echo "<script>state.pathNext = '{$parts[$curr_path_i]}';</script>";
                  else
                     echo "<script>state.pathNext = '';</script>";

                  if (count($parts) == 1 && $parts[0] == '')
                     $parts = [];
                  array_unshift($parts, '/');
                  $i = 0;

               <?php foreach ($parts as $part): ?>
                  <?php $is_curr = ($i == $curr_path_i); ?>
                  - tmp = "<?= query_update('pi', $i) ?>"
                  - tmp1 = "<?= $is_curr ? 'page_path__part_curr' : '' ?>"
                  a(href!=tmp, class!=tmp1).page_path__part.tdn
                     <?= $part ?>
                  <?php $i++; ?>
               <?php endforeach; ?>

            .page_content.ova.w100
               <script> var templates = {}; </script>
               <?php foreach ($types as $curr_type) : ?>
                  <?php $type_name = $curr_type['type_name']; ?>
                  <?php if (array_key_exists($type_name, $reg->DB->type)) : ?>

                     <template id="template_T_<?= $type_name ?>">
                        <?php DBItem::render($type_name); ?>
                     </template>
                     <script>templates['<?= $type_name ?>'] = document.getElementById('template_T_<?= $type_name ?>');</script>
                     <?php $reg->DB->type[$type_name]::render_addictive_templates(); ?>
                     
                  <?php else : ?>

                     <script>console.warn(`field/index.php: On template rendering, "<?= $type_name ?>" class is not registered in $reg->DB->type.`)</script>

                  <?php endif; ?>
                  
               <?php endforeach; ?>

               <?php $is_data = true; ?>
               <?php $parent = $db->at_path($path); ?>
               
               - tmp = '<?= $parent->id ?>'
               table.table(
                  data-update-link='./../scripts/?script=field-update',
                  data-render-link='./../scripts/?script=field-render',
                  data-value-render-link='./../scripts/?script=field-value-render',
                  data-parent-id!=tmp
               )
                  thead
                     tr
                        td Order
                        td.tac ID
                        td Key
                        td Name
                        td.w100 Value
                        td(colspan="2") Type
                        td Permission
                  tbody
                     <?php $children = $parent->get_children(); ?>

                     <?php if ($children == null) : ?>
                        <?php $is_data = false; ?>
                     <?php else : ?>
                        <?php foreach ($children as $child) : ?>
                        
                           <?php DBItem::render($child->type->name, $child); ?>

                        <?php endforeach; ?>
                     <?php endif; ?>

               - tmp = "<?= ( $is_data ? 'dn' : '' ) ?>"
               h2.tac(class!=tmp)#title_no-data No data


         <?php elseif ($_GET['view'] == 'type') : ?>
            | type

         <?php endif; ?>

         .page_foot-panel.w100.row.jcsb
            .row
               +button('Add', 'dark').page_button_with-content.page_button-add.rel(data-add-link='./../scripts/?script=field-add')
                  .page_button__content.abs.col.top0.left0.dn
                     <?php foreach ($types as $curr_type) : ?>
                        - tmp = "<?= $curr_type['id_type'] ?>"
                        - tmp1 = "<?= $curr_type['type_name'] ?>"
                        +box('div', 'dark').page_button-add__type(data-id!=tmp) !{tmp1}
                     <?php endforeach; ?>
                     
               +button('Delete', 'dark').page_button-delete(data-delete-link='./../scripts/?script=field-delete')
                  span(style="color: #6CF6FF88").dn#button-delete-count
                     |  (0)
               +button('Duplicate', 'dark').page_button-duplicate(data-duplicate-link='./../scripts/?script=field-duplicate')
                  span(style="color: #6CF6FF88").dn#button-duplicate-count
                     |  (0)

               :php
                  $move = ''; $move_arr = [];
                  if (array_key_exists('-jf_move', $_COOKIE))
                     $move = $_COOKIE['-jf_move'];
                  if ($move != '')
                     $move_arr = explode(',', $move);
                  $move_count = count($move_arr);

               - tmp = "<?= ( $move ? 'dn' : '' ) ?>"
               +button('Move', 'dark').page_button-move(class!=tmp, data-move-link='./../scripts/?script=field-move')
                  span(style="color: #6CF6FF88").dn#button-move-count
                     |  (0)
               - tmp = "<?= ( $move ? '' : 'dn' ) ?>"
               +button('Move', 'light').page_button_with-content.page_button-move-controls.rel(class!=tmp)
                  - tmp = "<?= ( $move ? \" ($move_count)\" : ' (0)' ) ?>"
                  span(style="color: #6e00ffa6")#button-move-controls-count
                     | !{tmp}
                  .page_button__content.abs.col.top0.left0.dn
                     +box('div', 'dark').page_button-move-here(data-move-link='./../scripts/?script=field-move') Here
                     +box('div', 'dark').page_button-move-cancel Cancel
            .row
               #statusbar.p1 Ready
         
